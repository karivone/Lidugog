<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
  body { font-family: 'Inter', sans-serif; background: #0c0c0c; }
    .sidebar {
      min-height: 100vh;
      background: #0c0c0c0c;
      color: #222;
      border-right: 1px solid #ececec;
      padding-top: 2.5rem;
      padding-bottom: 2rem;
      box-shadow: 2px 0 8px rgba(66, 185, 131, 0.04);
    }
    .sidebar .nav-link {
      color: #fcf9f9;
      font-weight: 600;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      padding: 0.7rem 1.2rem;
      transition: background 0.18s, color 0.18s;
    }
    .sidebar .nav-link.active, .sidebar .nav-link:hover {
      background: #42b983;
      color: #fff;
    }
    .sidebar-logo {
      font-size: 1.7rem;
      color: #42b983;
      font-weight: bold;
      letter-spacing: -1px;
      margin-bottom: 2.5rem;
      text-align: center;
    }
    .main-content { background: #f8f9fa; min-height: 100vh; }
    .card { border-radius: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    .volt-section-title { font-size: 1.3rem; color: #22223b; font-weight: 600; margin-bottom: 1rem; }
    .success-msg { color: #42b983; margin-top: 1rem; text-align: center; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <nav class="col-md-2 d-none d-md-block sidebar py-4">
        <div class="sidebar-logo mb-4">Lidugog</div>
        <ul class="nav flex-column">
          <li class="nav-item"><a class="nav-link active" href="/admin"><i class="fa-solid fa-gauge-high me-2"></i>Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="/create-blog"><i class="fa-solid fa-pen-to-square me-2"></i>Create Blog</a></li>
          <li class="nav-item"><a class="nav-link" href="/subscriptions"><i class="fa-solid fa-users me-2"></i>Subscriptions</a></li>
          <li class="nav-item"><a class="nav-link" href="/settings"><i class="fa-solid fa-gear me-2"></i>Settings</a></li>
        </ul>
      </nav>
      <main class="col-md-10 ms-sm-auto main-content px-4">
        <div class="volt-dashboard-container" style="max-width:1200px;margin:auto;padding-top:2.5rem;">
          <div class="volt-page-title" style="font-size:2.1rem;font-weight:700;color:#22223b;letter-spacing:-1px;margin-bottom:2.2rem;display:flex;align-items:center;gap:0.7rem;">
            <i class="fa-solid fa-gauge-high" style="color:#42b983;font-size:1.5em;"></i>
            Dashboard Overview
          </div>
          <div class="volt-row" style="display:flex;flex-wrap:wrap;gap:2.5rem 2.5rem;align-items:stretch;">
            <div class="volt-card" style="width:100%;background:#fff;border-radius:1.2rem;padding:2rem 2rem 1.5rem 2rem;box-shadow:0 2px 16px rgba(66,185,131,0.08);display:flex;flex-direction:column;justify-content:center;margin-bottom:2.5rem;">
              <div style="font-size:1.18rem;color:#222;font-weight:600;margin-bottom:0.7rem;display:flex;align-items:center;gap:0.5rem;">
                <i class='fa-solid fa-chart-bar' style='color:#42b983;font-size:1.2em;'></i>
                Blogs Overview
              </div>
              <canvas id="viewsChart" style="width:100%;height:220px;"></canvas>
            </div>
            <div class="volt-card" style="width:100%;background:#fff;border-radius:1.2rem;padding:2rem 2rem 1.5rem 2rem;box-shadow:0 2px 16px rgba(66,185,131,0.08);display:flex;flex-direction:column;justify-content:center;margin-bottom:2.5rem;">
              <div style="font-size:1.13rem;color:#222;font-weight:600;margin-bottom:1.1rem;display:flex;align-items:center;gap:0.5rem;">
                <i class="fa-solid fa-table" style="color:#42b983;font-size:1.1em;"></i>
                Blog Metrics
              </div>
              <div style="overflow-x:auto;">
                <table id="blogMetricsTable" style="width:100%;border-collapse:collapse;">
                  <thead>
                    <tr style="background:#f6f8fa;color:#222;font-weight:600;">
                      <th style="padding:0.7em 0.5em;text-align:left;">Title</th>
                      <th style="padding:0.7em 0.5em;text-align:right;">Likes</th>
                      <th style="padding:0.7em 0.5em;text-align:right;">Views</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr><td colspan="3" style="color:#aaa;text-align:center;">Loading...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div style="display:flex;flex-wrap:wrap;gap:2.5rem 2.5rem;width:100%;">
              <div class="volt-card" style="flex:1.2;min-width:320px;max-width:400px;height:340px;background:#fff;border-radius:1.2rem;padding:2rem 2rem 1.5rem 2rem;box-shadow:0 2px 16px rgba(66,185,131,0.08);display:flex;flex-direction:column;justify-content:center;">
                <div style="display:flex;align-items:center;gap:0.5rem;font-size:1.13rem;color:#222;font-weight:600;margin-bottom:0.5rem;">
                  <i class="fa-solid fa-chart-line" style="color:#42b983;font-size:1.2em;"></i>
                  Customers
                </div>
                <div id="customerFlowMetrics" style="font-size:1.05rem;color:#222;margin-bottom:0.7rem;line-height:1.6;"></div>
                <canvas id="customerFlowChart" width="320" height="120" style="display:block;margin:auto;"></canvas>
              </div>
              <div class="volt-card" style="flex:1;min-width:260px;max-width:320px;height:340px;background:#fff;border-radius:1.2rem;padding:2rem 2rem 1.5rem 2rem;box-shadow:0 2px 16px rgba(66,185,131,0.08);display:flex;flex-direction:column;justify-content:center;text-align:center;">
                <h3 style="color:#222;font-size:1.1rem;margin-bottom:1rem;font-weight:600;">Traffic Share by Device</h3>
                <div style="width:180px;height:180px;margin:auto;">
                  <canvas id="deviceShareChart" width="180" height="180" style="display:block;margin:auto;"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Blog Performance Chart and Metrics for Dashboard
    fetch('/api/posts')
      .then(res => res.json())
      .then(posts => {
        // Blog Metrics Table
        const table = document.getElementById('blogMetricsTable').getElementsByTagName('tbody')[0];
        if (posts.length) {
          table.innerHTML = posts.map(p => `
            <tr>
              <td style=\"padding:0.6em 0.5em;max-width:320px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;\">${p.title}</td>
              <td style=\"padding:0.6em 0.5em;text-align:right;\">${p.likes || 0}</td>
              <td style=\"padding:0.6em 0.5em;text-align:right;\">${p.views || 0}</td>
            </tr>
          `).join('');
        } else {
          table.innerHTML = '<tr><td colspan="3" style="color:#aaa;text-align:center;">No posts yet.</td></tr>';
        }

        // Chart: Top 5 posts by views
        const topPosts = [...posts].sort((a,b) => (b.views||0)-(a.views||0)).slice(0,5);
        const ctx = document.getElementById('viewsChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: topPosts.map(p => p.title.length > 18 ? p.title.slice(0,18)+'…' : p.title),
            datasets: [{
              label: 'Views',
              data: topPosts.map(p => p.views || 0),
              backgroundColor: '#42b983',
              borderRadius: 8,
            }]
          },
          options: {
            plugins: { legend: { display: false } },
            scales: {
              x: { grid: { display: false }, ticks: { color: '#222', font: { weight: 600 } } },
              y: { grid: { color: '#ececec' }, ticks: { color: '#888' }, beginAtZero: true }
            },
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2.2,
          }
        });
      });

    // Customer Flow (Monthly Visits)
    fetch('/api/visits/monthly')
      .then(res => res.json())
      .then(months => {
        const labels = months.map(m => m.month);
        const data = months.map(m => m.count);
        const ctx = document.getElementById('customerFlowChart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Visits',
              data,
              borderColor: '#42b983',
              backgroundColor: 'rgba(66,185,131,0.12)',
              fill: true,
              tension: 0.3,
              pointRadius: 4,
            }]
          },
          options: {
            plugins: { legend: { display: false } },
            scales: {
              x: { grid: { display: false }, ticks: { color: '#222' } },
              y: { grid: { color: '#ececec' }, ticks: { color: '#888' }, beginAtZero: true }
            },
            responsive: true,
            maintainAspectRatio: false,
          }
        });
        // Show meta info and improvement/decline
        if (data.length > 1) {
          const prev = data[data.length-2];
          const curr = data[data.length-1];
          const diff = curr - prev;
          const pct = prev ? ((diff/prev)*100).toFixed(1) : 'N/A';
          function formatMonth(ym) {
            const [y, m] = ym.split('-');
            const d = new Date(y, m-1, 1);
            return d.toLocaleString('default', { month: 'short', year: '2-digit' });
          }
          const range = `${formatMonth(labels[labels.length-2])} - ${formatMonth(labels[labels.length-1])}, WorldWide`;
          let changeText = '';
          if (diff > 0) changeText = `<span style=\"color:#42b983;font-weight:bold;\">▲ ${pct}% Since last month</span>`;
          else if (diff < 0) changeText = `<span style=\"color:#e74c3c;font-weight:bold;\">▼ ${pct}% Since last month</span>`;
          else changeText = `<span style=\"color:#888;\">No change from last month</span>`;
          document.getElementById('customerFlowMetrics').innerHTML =
            `${curr} customers (visits) for the current period<br>${range}<br>${changeText}`;
        } else if (data.length === 1) {
          function formatMonth(ym) {
            const [y, m] = ym.split('-');
            const d = new Date(y, m-1, 1);
            return d.toLocaleString('default', { month: 'short', year: '2-digit' });
          }
          document.getElementById('customerFlowMetrics').innerHTML =
            `${data[0]} customers (visits) for the current period<br>${formatMonth(labels[0])}, WorldWide`;
        }
      });

    // Device Share (Traffic Share)
    fetch('/api/visits/devices')
      .then(res => res.json())
      .then(devices => {
        const ctx = document.getElementById('deviceShareChart').getContext('2d');
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: devices.map(d => d.device),
            datasets: [{
              data: devices.map(d => d.count),
              backgroundColor: ['#42b983','#f1c40f','#888'],
            }]
          },
          options: {
            plugins: { legend: { position: 'bottom', labels: { color: '#222', font: { weight: 600 } } } },
            responsive: true,
            maintainAspectRatio: false,
            cutout: '65%',
          }
        });
      });
  </script>
